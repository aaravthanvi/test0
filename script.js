// ============================================
// TRANSLATIONS
// ============================================
const translations = {
  en: {
    title: 'Quote Galaxy',
    subtitle: 'Explore wisdom from around the world',
    'cat-all': 'All Quotes',
    'cat-life': 'Life',
    'cat-love': 'Love',
    'cat-success': 'Success',
    'cat-inspire': 'Inspiration',
    'cat-wisdom': 'Wisdom',
    'cat-time': 'Time',
    'cat-change': 'Change',
    'cat-mind': 'Mind',
    'cat-dream': 'Dreams',
    'cat-peace': 'Peace',
    back: 'Back',
    'new-quote': 'Next',
    share: 'Share',
    voice: 'Listen',
    loading: 'Loading...',
    offline: 'Offline mode',
    copied: 'Copied to clipboard!',
    viewed: 'quotes viewed',
    reading: 'Reading aloud...',
    stopped: 'Stopped',
    translating: 'Translating...',
    journeyComplete: 'Journey complete!'
  },
  hi: {
    title: 'कोट गैलेक्सी',
    subtitle: 'दुनिया भर से ज्ञान की खोज करें',
    'cat-all': 'सभी उद्धरण',
    'cat-life': 'जीवन',
    'cat-love': 'प्रेम',
    'cat-success': 'सफलता',
    'cat-inspire': 'प्रेरणा',
    'cat-wisdom': 'ज्ञान',
    'cat-time': 'समय',
    'cat-change': 'परिवर्तन',
    'cat-mind': 'मन',
    'cat-dream': 'सपने',
    'cat-peace': 'शांति',
    back: 'वापस',
    'new-quote': 'अगला',
    share: 'साझा करें',
    voice: 'सुनें',
    loading: 'लोड हो रहा है...',
    offline: 'ऑफ़लाइन मोड',
    copied: 'कॉपी किया गया!',
    viewed: 'उद्धरण देखे',
    reading: 'पढ़ रहे हैं...',
    stopped: 'रुका',
    translating: 'अनुवाद...',
    journeyComplete: 'यात्रा पूर्ण!'
  },
  es: {
    title: 'Quote Galaxy',
    subtitle: 'Explora la sabiduría de todo el mundo',
    'cat-all': 'Todas',
    'cat-life': 'Vida',
    'cat-love': 'Amor',
    'cat-success': 'Éxito',
    'cat-inspire': 'Inspiración',
    'cat-wisdom': 'Sabiduría',
    'cat-time': 'Tiempo',
    'cat-change': 'Cambio',
    'cat-mind': 'Mente',
    'cat-dream': 'Sueños',
    'cat-peace': 'Paz',
    back: 'Atrás',
    'new-quote': 'Siguiente',
    share: 'Compartir',
    voice: 'Escuchar',
    loading: 'Cargando...',
    offline: 'Sin conexión',
    copied: '¡Copiado!',
    viewed: 'citas vistas',
    reading: 'Leyendo...',
    stopped: 'Detenido',
    translating: 'Traduciendo...',
    journeyComplete: '¡Viaje completo!'
  },
  fr: {
    title: 'Quote Galaxy',
    subtitle: 'Explorez la sagesse du monde',
    'cat-all': 'Toutes',
    'cat-life': 'Vie',
    'cat-love': 'Amour',
    'cat-success': 'Succès',
    'cat-inspire': 'Inspiration',
    'cat-wisdom': 'Sagesse',
    'cat-time': 'Temps',
    'cat-change': 'Changement',
    'cat-mind': 'Esprit',
    'cat-dream': 'Rêves',
    'cat-peace': 'Paix',
    back: 'Retour',
    'new-quote': 'Suivant',
    share: 'Partager',
    voice: 'Écouter',
    loading: 'Chargement...',
    offline: 'Hors ligne',
    copied: 'Copié!',
    viewed: 'citations',
    reading: 'Lecture...',
    stopped: 'Arrêté',
    translating: 'Traduction...',
    journeyComplete: 'Voyage terminé!'
  },
  de: {
    title: 'Quote Galaxy',
    subtitle: 'Entdecke Weisheit',
    'cat-all': 'Alle',
    'cat-life': 'Leben',
    'cat-love': 'Liebe',
    'cat-success': 'Erfolg',
    'cat-inspire': 'Inspiration',
    'cat-wisdom': 'Weisheit',
    'cat-time': 'Zeit',
    'cat-change': 'Veränderung',
    'cat-mind': 'Geist',
    'cat-dream': 'Träume',
    'cat-peace': 'Frieden',
    back: 'Zurück',
    'new-quote': 'Weiter',
    share: 'Teilen',
    voice: 'Anhören',
    loading: 'Laden...',
    offline: 'Offline',
    copied: 'Kopiert!',
    viewed: 'Zitate',
    reading: 'Vorlesen...',
    stopped: 'Gestoppt',
    translating: 'Übersetzen...',
    journeyComplete: 'Reise abgeschlossen!'
  },
  ja: {
    title: 'Quote Galaxy',
    subtitle: '世界中の知恵を探求',
    'cat-all': 'すべて',
    'cat-life': '人生',
    'cat-love': '愛',
    'cat-success': '成功',
    'cat-inspire': '感動',
    'cat-wisdom': '知恵',
    'cat-time': '時間',
    'cat-change': '変化',
    'cat-mind': '心',
    'cat-dream': '夢',
    'cat-peace': '平和',
    back: '戻る',
    'new-quote': '次へ',
    share: '共有',
    voice: '聞く',
    loading: '読み込み中...',
    offline: 'オフライン',
    copied: 'コピー済み!',
    viewed: '引用',
    reading: '読み上げ中...',
    stopped: '停止',
    translating: '翻訳中...',
    journeyComplete: '旅完了!'
  },
  zh: {
    title: 'Quote Galaxy',
    subtitle: '探索智慧',
    'cat-all': '全部',
    'cat-life': '生活',
    'cat-love': '爱',
    'cat-success': '成功',
    'cat-inspire': '灵感',
    'cat-wisdom': '智慧',
    'cat-time': '时间',
    'cat-change': '变化',
    'cat-mind': '思维',
    'cat-dream': '梦想',
    'cat-peace': '和平',
    back: '返回',
    'new-quote': '下一个',
    share: '分享',
    voice: '听',
    loading: '加载中...',
    offline: '离线',
    copied: '已复制！',
    viewed: '引语',
    reading: '朗读中...',
    stopped: '已停止',
    translating: '翻译中...',
    journeyComplete: '旅程完成！'
  }
};

const languageCodes = {
  'en': 'en',
  'hi': 'hi',
  'es': 'es',
  'fr': 'fr',
  'de': 'de',
  'ja': 'ja',
  'zh': 'zh'
};

// ============================================
// VARIABLE DECLARATIONS
// ============================================
const mainMenu = document.getElementById('main-menu');
const categoriesSection = document.getElementById('categories');
const authorsSection = document.getElementById('authors');
const authorsGrid = document.getElementById('authors-grid');
const philosophySection = document.getElementById('philosophy');
const quoteSection = document.getElementById('quote-section');
const quoteText = document.getElementById('quote-text');
const quoteAuthor = document.getElementById('quote-author');
const statusMessage = document.getElementById('status-message');
const quoteContainer = document.getElementById('quote-container');
const backBtn = document.getElementById('back-btn');
const newQuoteBtn = document.getElementById('new-quote-btn');
const shareBtn = document.getElementById('share-btn');
const voiceBtn = document.getElementById('voice-btn');
const storyCardBtn = document.getElementById('story-card-btn');
const categoryButtons = document.querySelectorAll('.category-btn');
const philosophyButtons = document.querySelectorAll('.philosophy-btn');
const journeyCards = document.querySelectorAll('.journey-card');
const settingsBtn = document.getElementById('settings-btn');
const settingsPanel = document.getElementById('settings-panel');
const closeSettingsBtn = document.getElementById('close-settings');
const themeButtons = document.querySelectorAll('.theme-btn');
const languageSelect = document.getElementById('language-select');
const installBtn = document.getElementById('install-btn');
const browseCategoriesBtn = document.getElementById('browse-categories-btn');
const browseAuthorsBtn = document.getElementById('browse-authors-btn');
const browsePhilosophyBtn = document.getElementById('browse-philosophy-btn');
const backToMenuFromCategories = document.getElementById('back-to-menu-from-categories');
const backToMenuFromAuthors = document.getElementById('back-to-menu-from-authors');
const backToMenuFromPhilosophy = document.getElementById('back-to-menu-from-philosophy');
const journeyProgressContainer = document.getElementById('journey-progress-container');
const journeyTitle = document.getElementById('journey-title');
const journeyStep = document.getElementById('journey-step');
const journeyProgressBar = document.getElementById('journey-progress-bar');
const storyCardModal = document.getElementById('story-card-modal');
const closeStoryModal = document.getElementById('close-story-modal');
const storyCardCanvas = document.getElementById('story-card-canvas');
const downloadStoryBtn = document.getElementById('download-story-btn');
const zenCanvas = document.getElementById('zen-canvas');
const zenToggle = document.getElementById('zen-toggle');
const zenStyle = document.getElementById('zen-style');

let currentCategory = '';
let currentAuthor = '';
let currentJourney = null;
let journeyQuotes = [];
let journeyCurrentIndex = 0;
let allQuotes = [];
let topAuthors = [];
let shownQuoteIds = [];
let currentLanguage = 'en';
let easterEggInput = '';
let deferredPrompt = null;
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;
let currentQuoteData = null;
let zenAnimationId = null;
let zenEnabled = false;
let zenCurrentStyle = 'particles';

const categoryKeywords = {
  'all': [],
  'life': ['life', 'live', 'living', 'exist', 'journey', 'experience'],
  'love': ['love', 'heart', 'compassion', 'kindness', 'care', 'affection'],
  'success': ['success', 'achieve', 'goal', 'accomplish', 'win', 'victory'],
  'inspire': ['inspire', 'inspiration', 'motivate', 'encourage', 'empower', 'aspire', 'dream', 'possibility', 'potential', 'greatness'],
  'wisdom': ['wisdom', 'wise', 'knowledge', 'learn', 'understand', 'truth'],
  'time': ['time', 'moment', 'past', 'future', 'present', 'today', 'tomorrow'],
  'change': ['change', 'transform', 'grow', 'evolve', 'adapt', 'different'],
  'mind': ['mind', 'think', 'thought', 'mental', 'consciousness', 'imagination'],
  'dream': ['dream', 'vision', 'hope', 'aspiration', 'wish', 'desire'],
  'peace': ['peace', 'calm', 'quiet', 'tranquil', 'serene', 'still', 'silence', 'rest', 'harmony', 'balance', 'ease', 'gentle', 'soothe', 'relax'],
  'stoicism': ['stoic', 'virtue', 'wisdom', 'control', 'accept', 'endure', 'resilience', 'discipline', 'rational', 'nature', 'reason', 'fortitude'],
  'geeta': ['dharma', 'karma', 'yoga', 'duty', 'self', 'spirit', 'eternal', 'soul', 'truth', 'peace', 'knowledge', 'wisdom', 'devotion', 'action', 'meditation']
};

const journeyDefinitions = {
  morning: {
    title: 'Morning Focus',
    keywords: ['inspire', 'success', 'wisdom', 'mind', 'change']
  },
  night: {
    title: 'Evening Peace',
    keywords: ['peace', 'wisdom', 'time', 'love', 'mind']
  },
  overcome: {
    title: 'Overcoming Challenges',
    keywords: ['success', 'change', 'inspire', 'wisdom', 'life']
  },
  gratitude: {
    title: 'Gratitude Flow',
    keywords: ['love', 'peace', 'life', 'wisdom', 'dream']
  }
};

// ============================================
// CURATED CEO & SAGE QUOTES
// ============================================
const curatedQuotes = [
  { id: 10001, quote: "The hard part of creating a business is creating something people want.", author: "Sam Altman" },
  { id: 10002, quote: "You can create value with breakthrough innovation, incremental refinement, or complex coordination.", author: "Sam Altman" },
  { id: 10003, quote: "Great execution is at least 10 times more important and a hundred times harder than a good idea.", author: "Sam Altman" },
  { id: 10004, quote: "When something is important enough, you do it even if the odds are not in your favor.", author: "Elon Musk" },
  { id: 10005, quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
  { id: 10006, quote: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
  { id: 10007, quote: "The most important skill for getting rich is becoming a perpetual learner.", author: "Naval Ravikant" },
  { id: 10008, quote: "Price is what you pay. Value is what you get.", author: "Warren Buffett" },
  { id: 10009, quote: "The only true wisdom is in knowing you know nothing.", author: "Socrates" },
  { id: 10010, quote: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
  { id: 10011, quote: "Three things cannot be long hidden: the sun, the moon, and the truth.", author: "Buddha" },
  { id: 10012, quote: "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.", author: "Buddha" },
  { id: 20001, quote: "You grieve for those who are not worthy of grief; and yet speak words of wisdom. The wise grieve neither for the living nor for the dead.", author: "Bhagavad Gita 2.11" },
  { id: 20002, quote: "A calm person who is not afflicted by sense objects, and is steady in pain and pleasure, becomes fit for immortality.", author: "Bhagavad Gita 2.15" },
  { id: 20003, quote: "You have control over your respective duty only, but no control or claim over the results.", author: "Bhagavad Gita 2.47" },
  { id: 20004, quote: "One must elevate, not degrade, oneself by one's own mind. The Self is the friend of the self, and also the Self can be the enemy of oneself.", author: "Bhagavad Gita 6.5" },
  { id: 20005, quote: "Whoever remembers Me alone, at the time of death, leaving the body, attains My Supreme abode.", author: "Bhagavad Gita 8.5" }
];

// ============================================
// ZEN BACKGROUND SYSTEM
// ============================================
class ZenBackground {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.particles = [];
    this.time = 0;
    this.resize();
    window.addEventListener('resize', () => this.resize());
  }
  resize() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
  }
  initParticles() {
    this.particles = [];
    const count = Math.floor((this.canvas.width * this.canvas.height) / 15000);
    for (let i = 0; i < count; i++) {
      this.particles.push({
        x: Math.random() * this.canvas.width,
        y: Math.random() * this.canvas.height,
        vx: (Math.random() - 0.5) * 0.3,
        vy: (Math.random() - 0.5) * 0.3,
        size: Math.random() * 2 + 1,
        opacity: Math.random() * 0.5 + 0.2
      });
    }
  }
  drawParticles() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    this.particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
      this.ctx.beginPath();
      this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      this.ctx.fillStyle = this.hexToRgba(accentColor, p.opacity);
      this.ctx.fill();
    });
  }
  drawWaves() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    for (let i = 0; i < 3; i++) {
      this.ctx.beginPath();
      this.ctx.moveTo(0, this.canvas.height / 2);
      for (let x = 0; x < this.canvas.width; x += 5) {
        const y = Math.sin((x + this.time * (i + 1) * 0.5) * 0.01) * 50 + this.canvas.height / 2 + i * 100;
        this.ctx.lineTo(x, y);
      }
      this.ctx.strokeStyle = this.hexToRgba(accentColor, 0.1 + i * 0.05);
      this.ctx.lineWidth = 2;
      this.ctx.stroke();
    }
    this.time += 0.5;
  }
  drawCircles() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    const centerX = this.canvas.width / 2;
    const centerY = this.canvas.height / 2;
    for (let i = 1; i <= 5; i++) {
      const radius = 50 + i * 80 + Math.sin(this.time * 0.01 + i) * 20;
      this.ctx.beginPath();
      this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      this.ctx.strokeStyle = this.hexToRgba(accentColor, 0.15 - i * 0.02);
      this.ctx.lineWidth = 2;
      this.ctx.stroke();
    }
    this.time += 0.5;
  }
  hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }
  animate(style) {
    if (style === 'particles') {
      this.drawParticles();
    } else if (style === 'waves') {
      this.drawWaves();
    } else if (style === 'circles') {
      this.drawCircles();
    }
  }
}

let zenBackground = null;

function initZenBackground() {
  if (!zenBackground) {
    zenBackground = new ZenBackground(zenCanvas);
    zenBackground.initParticles();
  }
}

function startZenAnimation() {
  if (!zenEnabled) return;
  function animate() {
    if (!zenEnabled) {
      cancelAnimationFrame(zenAnimationId);
      return;
    }
    zenBackground.animate(zenCurrentStyle);
    zenAnimationId = requestAnimationFrame(animate);
  }
  zenCanvas.classList.add('active');
  animate();
}

function stopZenAnimation() {
  zenEnabled = false;
  if (zenAnimationId) {
    cancelAnimationFrame(zenAnimationId);
    zenAnimationId = null;
  }
  zenCanvas.classList.remove('active');
}

if (zenToggle) {
  zenToggle.addEventListener('change', (e) => {
    zenEnabled = e.target.checked;
    localStorage.setItem('zenEnabled', zenEnabled);
    if (zenEnabled) {
      initZenBackground();
      startZenAnimation();
    } else {
      stopZenAnimation();
    }
  });
}

if (zenStyle) {
  zenStyle.addEventListener('change', (e) => {
    zenCurrentStyle = e.target.value;
    localStorage.setItem('zenStyle', zenCurrentStyle);
    if (zenCurrentStyle === 'particles' && zenEnabled) {
      zenBackground.initParticles();
    }
  });
}

const savedZenEnabled = localStorage.getItem('zenEnabled') === 'true';
const savedZenStyle = localStorage.getItem('zenStyle') || 'particles';
if (zenToggle) zenToggle.checked = savedZenEnabled;
zenEnabled = savedZenEnabled;
if (zenStyle) zenStyle.value = savedZenStyle;
zenCurrentStyle = savedZenStyle;
if (zenEnabled) {
  initZenBackground();
  startZenAnimation();
}

// ============================================
// STORY CARD GENERATOR
// ============================================
function hexToRgba(hex, alpha) {
  if (hex.startsWith('rgba')) {
    return hex.replace(/\d+(\.\d+)?\)$/g, `${alpha})`);
  }
  hex = hex.replace('#', '');
  if (hex.length === 3) {
    hex = hex.split('').map(c => c + c).join('');
  }
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function generateStoryCard() {
  const ctx = storyCardCanvas.getContext('2d');
  const width = 1080;
  const height = 1920;
  const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
  const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
  
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, width, height);
  
  const gradient = ctx.createLinearGradient(0, 0, 0, height);
  gradient.addColorStop(0, hexToRgba(accentColor, 0.05));
  gradient.addColorStop(1, 'transparent');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);
  
  const quote = quoteText.textContent;
  const authorName = quoteAuthor.querySelector('[itemprop="name"]')?.textContent || 'Unknown';
  
  ctx.fillStyle = hexToRgba(accentColor, 0.3);
  ctx.font = 'bold 120px Arial';
  ctx.fillText('"', 100, 250);
  
  ctx.fillStyle = textColor;
  ctx.font = '600 64px Inter, sans-serif';
  ctx.textAlign = 'left';
  const maxWidth = width - 200;
  const lineHeight = 90;
  const words = quote.split(' ');
  let line = '';
  let y = 400;
  for (let word of words) {
    const testLine = line + word + ' ';
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && line !== '') {
      ctx.fillText(line, 100, y);
      line = word + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, 100, y);
  
  ctx.fillStyle = accentColor;
  ctx.font = '500 48px Inter, sans-serif';
  ctx.fillText('— ' + authorName, 100, y + 120);
  
  ctx.fillStyle = hexToRgba(textColor, 0.5);
  ctx.font = '400 36px Inter, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('✨ Quote Galaxy', width / 2, height - 100);
  
  storyCardModal.classList.remove('hidden');
}

if (storyCardBtn) {
  storyCardBtn.addEventListener('click', generateStoryCard);
}

if (closeStoryModal) {
  closeStoryModal.addEventListener('click', () => {
    storyCardModal.classList.add('hidden');
  });
}

if (downloadStoryBtn) {
  downloadStoryBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'quote-story.png';
    link.href = storyCardCanvas.toDataURL('image/png');
    link.click();
  });
}

// ============================================
// TRANSLATION FUNCTIONS
// ============================================
async function translateText(text, targetLang) {
  if (targetLang === 'en') return text;
  const cacheKey = `translation_${text}_${targetLang}`;
  const cached = localStorage.getItem(cacheKey);
  if (cached) return cached;
  try {
    const sourceLang = 'en';
    const langPair = `${sourceLang}|${languageCodes[targetLang]}`;
    const encodedText = encodeURIComponent(text);
    const apiUrl = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${langPair}`;
    const response = await fetch(apiUrl);
    const data = await response.json();
    if (data.responseStatus === 200 && data.responseData.translatedText) {
      const translated = data.responseData.translatedText;
      try {
        localStorage.setItem(cacheKey, translated);
      } catch (e) {
        clearOldTranslations();
      }
      return translated;
    }
    return text;
  } catch (error) {
    console.log('Translation error:', error);
    return text;
  }
}

function clearOldTranslations() {
  const keys = Object.keys(localStorage);
  const translationKeys = keys.filter(k => k.startsWith('translation_'));
  const toRemove = translationKeys.slice(0, Math.floor(translationKeys.length / 2));
  toRemove.forEach(key => localStorage.removeItem(key));
}

// ============================================
// QUOTE FUNCTIONS
// ============================================
function quoteMatchesCategory(quote, category) {
  if (category === 'all') return true;
  const keywords = categoryKeywords[category] || [category];
  const quoteText = quote.quote.toLowerCase();
  return keywords.some(keyword => quoteText.includes(keyword.toLowerCase()));
}

function saveQuotesToCache(quotes) {
  try {
    localStorage.setItem('allQuotes', JSON.stringify(quotes));
  } catch (error) {
    console.log('Could not save to cache:', error);
  }
}

function getCachedQuotes() {
  try {
    const cached = localStorage.getItem('allQuotes');
    return cached ? JSON.parse(cached) : [];
  } catch (error) {
    return [];
  }
}

function saveShownQuotes() {
  try {
    const key = currentAuthor ? `shownQuotes_author_${currentAuthor}` : `shownQuotes_${currentCategory}`;
    localStorage.setItem(key, JSON.stringify(shownQuoteIds));
  } catch (error) {
    console.log('Could not save shown quotes:', error);
  }
}

function loadShownQuotes() {
  try {
    const key = currentAuthor ? `shownQuotes_author_${currentAuthor}` : `shownQuotes_${currentCategory}`;
    const shown = localStorage.getItem(key);
    shownQuoteIds = shown ? JSON.parse(shown) : [];
  } catch (error) {
    shownQuoteIds = [];
  }
}

async function fetchAllQuotes() {
  try {
    quoteText.textContent = translations[currentLanguage].loading;
    quoteAuthor.textContent = '';
    statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].loading;
    
    let combinedQuotes = [];
    
    try {
      const response1 = await fetch('https://dummyjson.com/quotes?limit=0');
      if (response1.ok) {
        const data1 = await response1.json();
        combinedQuotes = combinedQuotes.concat(data1.quotes);
        console.log('DummyJSON: Loaded', data1.quotes.length, 'quotes');
      }
    } catch (err) {
      console.log('DummyJSON failed:', err);
    }
    
    try {
      let quotablePage = 1;
      let hasMore = true;
      while (hasMore && quotablePage <= 15) {
        const response2 = await fetch(`https://api.quotable.io/quotes?page=${quotablePage}&limit=20`);
        if (response2.ok) {
          const data2 = await response2.json();
          const formattedQuotes = data2.results.map((q, index) => ({
            id: 1500 + (quotablePage * 20) + index,
            quote: q.content,
            author: q.author
          }));
          combinedQuotes = combinedQuotes.concat(formattedQuotes);
          hasMore = data2.totalPages > quotablePage;
          quotablePage++;
        } else {
          hasMore = false;
        }
      }
      console.log('Quotable.io: Loaded quotes');
    } catch (err) {
      console.log('Quotable.io failed:', err);
    }
    
    try {
      const response3 = await fetch('https://zenquotes.io/api/quotes');
      if (response3.ok) {
        const data3 = await response3.json();
        const formattedQuotes = data3.map((q, index) => ({
          id: 2000 + index,
          quote: q.q,
          author: q.a
        }));
        combinedQuotes = combinedQuotes.concat(formattedQuotes);
        console.log('ZenQuotes: Loaded', formattedQuotes.length, 'quotes');
      }
    } catch (err) {
      console.log('ZenQuotes failed:', err);
    }
    
    const uniqueQuotes = [];
    const seenQuotes = new Set();
    combinedQuotes.forEach(quote => {
      const normalizedQuote = quote.quote.toLowerCase().trim();
      if (!seenQuotes.has(normalizedQuote)) {
        seenQuotes.add(normalizedQuote);
        uniqueQuotes.push(quote);
      }
    });
    
    allQuotes = uniqueQuotes;
    allQuotes = allQuotes.concat(curatedQuotes);
    console.log('Total unique quotes loaded:', allQuotes.length);
    
    if (allQuotes.length === 0) {
      throw new Error('No quotes loaded from any API');
    }
    
    saveQuotesToCache(allQuotes);
    showQuoteFromCategory();
    statusMessage.innerHTML = `${allQuotes.length} quotes loaded`;
  } catch (error) {
    console.log('All APIs failed:', error);
    loadCachedQuotes();
  }
}

function loadCachedQuotes() {
  const cached = getCachedQuotes();
  if (cached.length > 0) {
    allQuotes = cached;
    showQuoteFromCategory();
    statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].offline;
  } else {
    quoteText.textContent = 'Unable to load quotes. Please check your internet connection.';
    quoteAuthor.textContent = '';
    statusMessage.innerHTML = 'No cached quotes';
  }
}

function showQuoteFromCategory() {
  let filteredQuotes;
  
  if (currentCategory === 'geeta') {
    filteredQuotes = allQuotes.filter(q => {
      return q.id >= 20001 && q.author && q.author.includes('Bhagavad Gita');
    });
    if (filteredQuotes.length === 0) {
      statusMessage.innerHTML = 'No Geeta verses found. Total quotes: ' + allQuotes.length;
      return;
    }
  } else if (currentCategory === 'stoicism') {
    filteredQuotes = allQuotes.filter(q => 
      q.author.toLowerCase().includes('marcus') || 
      q.author.toLowerCase().includes('seneca') || 
      q.author.toLowerCase().includes('epictetus') || 
      q.quote.toLowerCase().includes('stoic')
    );
  } else if (currentCategory === 'all') {
    filteredQuotes = allQuotes;
  } else {
    filteredQuotes = allQuotes.filter(q => quoteMatchesCategory(q, currentCategory));
  }
  
  if (filteredQuotes.length < 10 && currentCategory !== 'geeta' && currentCategory !== 'stoicism') {
    filteredQuotes = allQuotes;
    statusMessage.innerHTML = 'Showing all quotes for variety';
  }
  
  const availableQuotes = filteredQuotes.filter(q => !shownQuoteIds.includes(q.id));
  
  if (availableQuotes.length === 0) {
    shownQuoteIds = [];
    saveShownQuotes();
    return showQuoteFromCategory();
  }
  
  const randomIndex = Math.floor(Math.random() * availableQuotes.length);
  const selectedQuote = availableQuotes[randomIndex];
  shownQuoteIds.push(selectedQuote.id);
  saveShownQuotes();
  displayQuote(selectedQuote);
}

async function displayQuote(quote, isLanguageSwitch = false) {
  currentQuoteData = quote;
  quoteContainer.classList.remove('quote-reveal');
  void quoteContainer.offsetWidth;
  quoteContainer.classList.add('quote-reveal');
  
  if (currentLanguage !== 'en') {
    statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].translating;
  }
  
  const translatedQuote = await translateText(quote.quote, currentLanguage);
  const translatedAuthor = await translateText(quote.author, currentLanguage);
  
  quoteText.textContent = translatedQuote;
  const authorSpan = quoteAuthor.querySelector('[itemprop="name"]');
  if (authorSpan) authorSpan.textContent = translatedAuthor;
  
  statusMessage.innerHTML = `${shownQuoteIds.length} ${translations[currentLanguage].viewed}`;
}

// ============================================
// UI FUNCTIONS
// ============================================
function showQuoteSection() {
  mainMenu.classList.add('hidden');
  categoriesSection.classList.add('hidden');
  authorsSection.classList.add('hidden');
  philosophySection.classList.add('hidden');
  quoteSection.classList.remove('hidden');
  quoteSection.classList.add('fade-enter');
  if (backBtn) backBtn.focus();
}

function showMainMenu() {
  quoteSection.classList.add('hidden');
  categoriesSection.classList.add('hidden');
  authorsSection.classList.add('hidden');
  philosophySection.classList.add('hidden');
  mainMenu.classList.remove('hidden');
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    if (voiceBtn) voiceBtn.classList.remove('voice-active');
  }
}

function showCategoriesSection() {
  mainMenu.classList.add('hidden');
  quoteSection.classList.add('hidden');
  authorsSection.classList.add('hidden');
  philosophySection.classList.add('hidden');
  categoriesSection.classList.remove('hidden');
}

function shareQuote() {
  const quote = quoteText.textContent;
  const authorName = quoteAuthor.querySelector('[itemprop="name"]')?.textContent || 'Unknown';
  const shareText = `"${quote}"\n— ${authorName}\n\n✨ From Quote Galaxy\n${window.location.href}`;
  const shareTitle = 'Inspirational Quote';
  if (navigator.share) {
    navigator.share({
      title: shareTitle,
      text: shareText,
      url: window.location.href
    }).catch(err => console.log('Share cancelled'));
  } else {
    navigator.clipboard.writeText(shareText).then(() => {
      const tempStatus = statusMessage.innerHTML;
      statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].copied;
      setTimeout(() => {
        statusMessage.innerHTML = tempStatus;
      }, 2000);
    }).catch(() => {
      statusMessage.innerHTML = 'Could not copy';
    });
  }
}

function speakQuote() {
  if (!speechSynthesis) {
    statusMessage.innerHTML = 'Voice not supported';
    return;
  }
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    if (voiceBtn) voiceBtn.classList.remove('voice-active');
    statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].stopped;
    return;
  }
  const quote = quoteText.textContent;
  const author = quoteAuthor.textContent;
  const textToSpeak = `${quote}. ${author}`;
  currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
  currentUtterance.lang = currentLanguage === 'en' ? 'en-US' : currentLanguage === 'hi' ? 'hi-IN' : 'en-US';
  currentUtterance.rate = 0.9;
  currentUtterance.pitch = 1.0;
  currentUtterance.volume = 1.0;
  currentUtterance.onstart = () => {
    if (voiceBtn) voiceBtn.classList.add('voice-active');
    statusMessage.innerHTML = '<span></span>' + translations[currentLanguage].reading;
  };
  currentUtterance.onend = () => {
    if (voiceBtn) voiceBtn.classList.remove('voice-active');
    statusMessage.innerHTML = `${shownQuoteIds.length} ${translations[currentLanguage].viewed}`;
  };
  currentUtterance.onerror = () => {
    if (voiceBtn) voiceBtn.classList.remove('voice-active');
    statusMessage.innerHTML = 'Voice error';
  };
  speechSynthesis.speak(currentUtterance);
}

function toggleSettings() {
  if (settingsPanel) settingsPanel.classList.toggle('open');
}

function setTheme(themeName) {
  document.documentElement.setAttribute('data-theme', themeName);
  localStorage.setItem('theme', themeName);
  const themeColorMeta = document.querySelector('meta[name="theme-color"]');
  if (themeColorMeta) {
    const computedColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    themeColorMeta.setAttribute('content', computedColor);
  }
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'vscode-dark';
  setTheme(savedTheme);
}

async function setLanguage(lang) {
  currentLanguage = lang;
  localStorage.setItem('language', lang);
  document.documentElement.setAttribute('lang', lang);
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[lang] && translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });
  if (currentQuoteData && !quoteSection.classList.contains('hidden')) {
    await displayQuote(currentQuoteData, true);
  }
}

function detectLanguage() {
  const browserLang = navigator.language.split('-')[0];
  const savedLang = localStorage.getItem('language');
  return savedLang || (translations[browserLang] ? browserLang : 'en');
}

function detectDevice() {
  const ua = navigator.userAgent;
  let deviceType = 'Desktop', os = 'Unknown', browser = 'Unknown';
  if (/mobile/i.test(ua)) deviceType = 'Mobile';
  else if (/tablet|ipad/i.test(ua)) deviceType = 'Tablet';
  if (/windows/i.test(ua)) os = 'Windows';
  else if (/mac/i.test(ua)) os = 'macOS';
  else if (/linux/i.test(ua)) os = 'Linux';
  else if (/android/i.test(ua)) os = 'Android';
  else if (/iphone|ipad|ipod/i.test(ua)) os = 'iOS';
  if (/firefox/i.test(ua)) browser = 'Firefox';
  else if (/chrome/i.test(ua) && !/edg/i.test(ua)) browser = 'Chrome';
  else if (/safari/i.test(ua) && !/chrome/i.test(ua)) browser = 'Safari';
  else if (/edg/i.test(ua)) browser = 'Edge';
  else if (/opera|opr/i.test(ua)) browser = 'Opera';
  
  const deviceType_el = document.getElementById('device-type');
  const deviceOS_el = document.getElementById('device-os');
  const deviceBrowser_el = document.getElementById('device-browser');
  
  if (deviceType_el) deviceType_el.textContent = `Type: ${deviceType}`;
  if (deviceOS_el) deviceOS_el.textContent = `OS: ${os}`;
  if (deviceBrowser_el) deviceBrowser_el.textContent = `Browser: ${browser}`;
  
  if (deviceType === 'Mobile') document.body.classList.add('mobile-layout');
  return { deviceType, os, browser };
}

// ============================================
// EVENT LISTENERS
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  // Navigation buttons
  if (browseCategoriesBtn) browseCategoriesBtn.addEventListener('click', showCategoriesSection);
  if (browseAuthorsBtn) browseCategoriesBtn.addEventListener('click', showCategoriesSection);
  if (browsePhilosophyBtn) browsePhilosophyBtn.addEventListener('click', showCategoriesSection);
  if (backToMenuFromCategories) backToMenuFromCategories.addEventListener('click', showMainMenu);
  if (backToMenuFromAuthors) backToMenuFromAuthors.addEventListener('click', showMainMenu);
  if (backToMenuFromPhilosophy) backToMenuFromPhilosophy.addEventListener('click', showMainMenu);
  
  // Category buttons
  categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
      currentCategory = button.getAttribute('data-category');
      currentAuthor = '';
      loadShownQuotes();
      showQuoteSection();
      if (allQuotes.length > 0) {
        showQuoteFromCategory();
      } else {
        fetchAllQuotes();
      }
    });
  });
  
  // Back button
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      showMainMenu();
    });
  }
  
  // New quote button
  if (newQuoteBtn) {
    newQuoteBtn.addEventListener('click', () => {
      if (allQuotes.length > 0) {
        showQuoteFromCategory();
      } else {
        fetchAllQuotes();
      }
    });
  }
  
  // Share button
  if (shareBtn) shareBtn.addEventListener('click', shareQuote);
  
  // Voice button
  if (voiceBtn) voiceBtn.addEventListener('click', speakQuote);
  
  // Settings button
  if (settingsBtn) settingsBtn.addEventListener('click', toggleSettings);
  if (closeSettingsBtn) closeSettingsBtn.addEventListener('click', toggleSettings);
  
  // Theme buttons
  themeButtons.forEach(button => {
    button.addEventListener('click', () => {
      const theme = button.getAttribute('data-theme');
      setTheme(theme);
    });
  });
  
  // Language select
  if (languageSelect) {
    languageSelect.addEventListener('change', (e) => {
      setLanguage(e.target.value);
    });
  }
  
  // Fetch quotes on load
  const cached = getCachedQuotes();
  if (cached.length > 0) {
    allQuotes = cached;
    console.log('Loaded', allQuotes.length, 'quotes from cache');
  } else {
    fetchAllQuotes();
  }
});

// ============================================
// INITIALIZATION
// ============================================
console.log('✨ Quote Galaxy initialized!');
loadTheme();
const detectedLang = detectLanguage();
if (languageSelect) languageSelect.value = detectedLang;
setLanguage(detectedLang);
detectDevice();
