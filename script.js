// ============================================
// TRANSLATIONS
// ============================================

const translations = {
    en: {
        title: 'Quote Galaxy',
        subtitle: 'Explore wisdom from around the world',
        'cat-all': 'All Quotes',
        'cat-life': 'Life',
        'cat-love': 'Love',
        'cat-success': 'Success',
        'cat-inspire': 'Inspiration',
        'cat-wisdom': 'Wisdom',
        'cat-time': 'Time',
        'cat-change': 'Change',
        'cat-mind': 'Mind',
        'cat-dream': 'Dreams',
        'cat-peace': 'Peace',
        back: 'Back',
        'new-quote': 'Next',
        share: 'Share',
        voice: 'Listen',
        loading: 'Loading...',
        offline: 'Offline mode',
        copied: 'Copied to clipboard!',
        viewed: 'quotes viewed',
        reading: 'Reading aloud...',
        stopped: 'Stopped',
        translating: 'Translating...',
        journeyComplete: 'Journey complete!'
    },
    hi: {
        title: '‡§ï‡•ã‡§ü ‡§ó‡•à‡§≤‡•á‡§ï‡•ç‡§∏‡•Ä',
        subtitle: '‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ ‡§≠‡§∞ ‡§∏‡•á ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç',
        'cat-all': '‡§∏‡§≠‡•Ä ‡§â‡§¶‡•ç‡§ß‡§∞‡§£',
        'cat-life': '‡§ú‡•Ä‡§µ‡§®',
        'cat-love': '‡§™‡•ç‡§∞‡•á‡§Æ',
        'cat-success': '‡§∏‡§´‡§≤‡§§‡§æ',
        'cat-inspire': '‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ',
        'cat-wisdom': '‡§ú‡•ç‡§û‡§æ‡§®',
        'cat-time': '‡§∏‡§Æ‡§Ø',
        'cat-change': '‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®',
        'cat-mind': '‡§Æ‡§®',
        'cat-dream': '‡§∏‡§™‡§®‡•á',
        'cat-peace': '‡§∂‡§æ‡§Ç‡§§‡§ø',
        back: '‡§µ‡§æ‡§™‡§∏',
        'new-quote': '‡§Ö‡§ó‡§≤‡§æ',
        share: '‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç',
        voice: '‡§∏‡•Å‡§®‡•á‡§Ç',
        loading: '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
        offline: '‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§Æ‡•ã‡§°',
        copied: '‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!',
        viewed: '‡§â‡§¶‡•ç‡§ß‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á',
        reading: '‡§™‡§¢‡§º ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...',
        stopped: '‡§∞‡•Å‡§ï‡§æ',
        translating: '‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶...',
        journeyComplete: '‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£!'
    },
    es: {
        title: 'Quote Galaxy',
        subtitle: 'Explora la sabidur√≠a de todo el mundo',
        'cat-all': 'Todas',
        'cat-life': 'Vida',
        'cat-love': 'Amor',
        'cat-success': '√âxito',
        'cat-inspire': 'Inspiraci√≥n',
        'cat-wisdom': 'Sabidur√≠a',
        'cat-time': 'Tiempo',
        'cat-change': 'Cambio',
        'cat-mind': 'Mente',
        'cat-dream': 'Sue√±os',
        'cat-peace': 'Paz',
        back: 'Atr√°s',
        'new-quote': 'Siguiente',
        share: 'Compartir',
        voice: 'Escuchar',
        loading: 'Cargando...',
        offline: 'Sin conexi√≥n',
        copied: '¬°Copiado!',
        viewed: 'citas vistas',
        reading: 'Leyendo...',
        stopped: 'Detenido',
        translating: 'Traduciendo...',
        journeyComplete: '¬°Viaje completo!'
    },
    fr: {
        title: 'Quote Galaxy',
        subtitle: 'Explorez la sagesse du monde',
        'cat-all': 'Toutes',
        'cat-life': 'Vie',
        'cat-love': 'Amour',
        'cat-success': 'Succ√®s',
        'cat-inspire': 'Inspiration',
        'cat-wisdom': 'Sagesse',
        'cat-time': 'Temps',
        'cat-change': 'Changement',
        'cat-mind': 'Esprit',
        'cat-dream': 'R√™ves',
        'cat-peace': 'Paix',
        back: 'Retour',
        'new-quote': 'Suivant',
        share: 'Partager',
        voice: '√âcouter',
        loading: 'Chargement...',
        offline: 'Hors ligne',
        copied: 'Copi√©!',
        viewed: 'citations',
        reading: 'Lecture...',
        stopped: 'Arr√™t√©',
        translating: 'Traduction...',
        journeyComplete: 'Voyage termin√©!'
    },
    de: {
        title: 'Quote Galaxy',
        subtitle: 'Entdecke Weisheit',
        'cat-all': 'Alle',
        'cat-life': 'Leben',
        'cat-love': 'Liebe',
        'cat-success': 'Erfolg',
        'cat-inspire': 'Inspiration',
        'cat-wisdom': 'Weisheit',
        'cat-time': 'Zeit',
        'cat-change': 'Ver√§nderung',
        'cat-mind': 'Geist',
        'cat-dream': 'Tr√§ume',
        'cat-peace': 'Frieden',
        back: 'Zur√ºck',
        'new-quote': 'Weiter',
        share: 'Teilen',
        voice: 'Anh√∂ren',
        loading: 'Laden...',
        offline: 'Offline',
        copied: 'Kopiert!',
        viewed: 'Zitate',
        reading: 'Vorlesen...',
        stopped: 'Gestoppt',
        translating: '√úbersetzen...',
        journeyComplete: 'Reise abgeschlossen!'
    },
    ja: {
        title: 'Quote Galaxy',
        subtitle: '‰∏ñÁïå‰∏≠„ÅÆÁü•ÊÅµ„ÇíÊé¢Ê±Ç',
        'cat-all': '„Åô„Åπ„Å¶',
        'cat-life': '‰∫∫Áîü',
        'cat-love': 'ÊÑõ',
        'cat-success': 'ÊàêÂäü',
        'cat-inspire': 'ÊÑüÂãï',
        'cat-wisdom': 'Áü•ÊÅµ',
        'cat-time': 'ÊôÇÈñì',
        'cat-change': 'Â§âÂåñ',
        'cat-mind': 'ÂøÉ',
        'cat-dream': 'Â§¢',
        'cat-peace': 'Âπ≥Âíå',
        back: 'Êàª„Çã',
        'new-quote': 'Ê¨°„Å∏',
        share: 'ÂÖ±Êúâ',
        voice: 'ËÅû„Åè',
        loading: 'Ë™≠„ÅøËæº„Åø‰∏≠...',
        offline: '„Ç™„Éï„É©„Ç§„É≥',
        copied: '„Ç≥„Éî„ÉºÊ∏à„Åø!',
        viewed: 'ÂºïÁî®',
        reading: 'Ë™≠„Åø‰∏ä„Åí‰∏≠...',
        stopped: 'ÂÅúÊ≠¢',
        translating: 'ÁøªË®≥‰∏≠...',
        journeyComplete: 'ÊóÖÂÆå‰∫ÜÔºÅ'
    },
    zh: {
        title: 'Quote Galaxy',
        subtitle: 'Êé¢Á¥¢Êô∫ÊÖß',
        'cat-all': 'ÂÖ®ÈÉ®',
        'cat-life': 'ÁîüÊ¥ª',
        'cat-love': 'Áà±',
        'cat-success': 'ÊàêÂäü',
        'cat-inspire': 'ÁÅµÊÑü',
        'cat-wisdom': 'Êô∫ÊÖß',
        'cat-time': 'Êó∂Èó¥',
        'cat-change': 'ÂèòÂåñ',
        'cat-mind': 'ÊÄùÁª¥',
        'cat-dream': 'Ê¢¶ÊÉ≥',
        'cat-peace': 'ÂíåÂπ≥',
        back: 'ËøîÂõû',
        'new-quote': '‰∏ã‰∏Ä‰∏™',
        share: 'ÂàÜ‰∫´',
        voice: 'Âê¨',
        loading: 'Âä†ËΩΩ‰∏≠...',
        offline: 'Á¶ªÁ∫ø',
        copied: 'Â∑≤Â§çÂà∂ÔºÅ',
        viewed: 'ÂºïËØ≠',
        reading: 'ÊúóËØª‰∏≠...',
        stopped: 'Â∑≤ÂÅúÊ≠¢',
        translating: 'ÁøªËØë‰∏≠...',
        journeyComplete: 'ÊóÖÁ®ãÂÆåÊàêÔºÅ'
    }
};

const languageCodes = {
    'en': 'en', 'hi': 'hi', 'es': 'es', 'fr': 'fr', 'de': 'de', 'ja': 'ja', 'zh': 'zh'
};

// ============================================
// VARIABLE DECLARATIONS
// ============================================

const mainMenu = document.getElementById('main-menu');
const categoriesSection = document.getElementById('categories');
const authorsSection = document.getElementById('authors');
const authorsGrid = document.getElementById('authors-grid');
const philosophySection = document.getElementById('philosophy');
const quoteSection = document.getElementById('quote-section');
const quoteText = document.getElementById('quote-text');
const quoteAuthor = document.getElementById('quote-author');
const statusMessage = document.getElementById('status-message');
const quoteContainer = document.getElementById('quote-container');
const backBtn = document.getElementById('back-btn');
const newQuoteBtn = document.getElementById('new-quote-btn');
const shareBtn = document.getElementById('share-btn');
const voiceBtn = document.getElementById('voice-btn');
const storyCardBtn = document.getElementById('story-card-btn');
const categoryButtons = document.querySelectorAll('.category-btn');
const philosophyButtons = document.querySelectorAll('.philosophy-btn');
const journeyCards = document.querySelectorAll('.journey-card');
const settingsBtn = document.getElementById('settings-btn');
const settingsPanel = document.getElementById('settings-panel');
const closeSettingsBtn = document.getElementById('close-settings');
const themeButtons = document.querySelectorAll('.theme-btn');
const languageSelect = document.getElementById('language-select');
const installBtn = document.getElementById('install-btn');
const browseCategoriesBtn = document.getElementById('browse-categories-btn');
const browseAuthorsBtn = document.getElementById('browse-authors-btn');
const browsePhilosophyBtn = document.getElementById('browse-philosophy-btn');
const backToMenuFromCategories = document.getElementById('back-to-menu-from-categories');
const backToMenuFromAuthors = document.getElementById('back-to-menu-from-authors');
const backToMenuFromPhilosophy = document.getElementById('back-to-menu-from-philosophy');
const journeyProgressContainer = document.getElementById('journey-progress-container');
const journeyTitle = document.getElementById('journey-title');
const journeyStep = document.getElementById('journey-step');
const journeyProgressBar = document.getElementById('journey-progress-bar');
const storyCardModal = document.getElementById('story-card-modal');
const closeStoryModal = document.getElementById('close-story-modal');
const storyCardCanvas = document.getElementById('story-card-canvas');
const downloadStoryBtn = document.getElementById('download-story-btn');
const zenCanvas = document.getElementById('zen-canvas');
const zenToggle = document.getElementById('zen-toggle');
const zenStyle = document.getElementById('zen-style');

let currentCategory = '';
let currentAuthor = '';
let currentJourney = null;
let journeyQuotes = [];
let journeyCurrentIndex = 0;
let allQuotes = [];
let topAuthors = [];
let shownQuoteIds = [];
let currentLanguage = 'en';
let easterEggInput = '';
let deferredPrompt = null;
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;
let currentQuoteData = null;
let zenAnimationId = null;
let zenEnabled = false;
let zenCurrentStyle = 'particles';

const categoryKeywords = {
    'all': [],
    'life': ['life', 'live', 'living', 'exist', 'journey', 'experience'],
    'love': ['love', 'heart', 'compassion', 'kindness', 'care', 'affection'],
    'success': ['success', 'achieve', 'goal', 'accomplish', 'win', 'victory'],
    'inspire': ['inspire', 'inspiration', 'motivate', 'encourage', 'empower', 'aspire', 'dream', 'possibility', 'potential', 'greatness'],
    'wisdom': ['wisdom', 'wise', 'knowledge', 'learn', 'understand', 'truth'],
    'time': ['time', 'moment', 'past', 'future', 'present', 'today', 'tomorrow'],
    'change': ['change', 'transform', 'grow', 'evolve', 'adapt', 'different'],
    'mind': ['mind', 'think', 'thought', 'mental', 'consciousness', 'imagination'],
    'dream': ['dream', 'vision', 'hope', 'aspiration', 'wish', 'desire'],
    'peace': ['peace', 'calm', 'quiet', 'tranquil', 'serene', 'still', 'silence', 'rest', 'harmony', 'balance', 'ease', 'gentle', 'soothe', 'relax'],
    'stoicism': ['stoic', 'virtue', 'wisdom', 'control', 'accept', 'endure', 'resilience', 'discipline', 'rational', 'nature', 'reason', 'fortitude']
};

const journeyDefinitions = {
    morning: {
        title: 'Morning Focus',
        keywords: ['inspire', 'success', 'wisdom', 'mind', 'change']
    },
    night: {
        title: 'Evening Peace',
        keywords: ['peace', 'wisdom', 'time', 'love', 'mind']
    },
    overcome: {
        title: 'Overcoming Challenges',
        keywords: ['success', 'change', 'inspire', 'wisdom', 'life']
    },
    gratitude: {
        title: 'Gratitude Flow',
        keywords: ['love', 'peace', 'life', 'wisdom', 'dream']
    }
};

// ============================================
// CURATED CEO & SAGE QUOTES
// ============================================

const curatedQuotes = [
    // Sam Altman (OpenAI CEO)
    { id: 10001, quote: "The hard part of creating a business is creating something people want.", author: "Sam Altman" },
    { id: 10002, quote: "You can create value with breakthrough innovation, incremental refinement, or complex coordination.", author: "Sam Altman" },
    { id: 10003, quote: "Great execution is at least 10 times more important and a hundred times harder than a good idea.", author: "Sam Altman" },
    { id: 10004, quote: "I think the best way to get a good idea is to get a lot of ideas.", author: "Sam Altman" },
    { id: 10005, quote: "Aim to be the best in the world at whatever you do professionally.", author: "Sam Altman" },
    { id: 10006, quote: "If you're not in the arena also getting your ass kicked, I'm not interested in your feedback.", author: "Sam Altman" },
    { id: 10007, quote: "In the long run, the quality of people you surround yourself with is a huge predictor of success.", author: "Sam Altman" },
    { id: 10008, quote: "The most impressive people I know care a lot about their work.", author: "Sam Altman" },
    { id: 10009, quote: "Nothing is as valuable as an unstructured afternoon.", author: "Sam Altman" },
    { id: 10010, quote: "You want to be able to project yourself 20 or 30 years into the future, and then think backwards from there.", author: "Sam Altman" },
    
    // Elon Musk (Tesla, SpaceX, X CEO)
    { id: 10011, quote: "When something is important enough, you do it even if the odds are not in your favor.", author: "Elon Musk" },
    { id: 10012, quote: "Persistence is very important. You should not give up unless you are forced to give up.", author: "Elon Musk" },
    { id: 10013, quote: "I think it's possible for ordinary people to choose to be extraordinary.", author: "Elon Musk" },
    { id: 10014, quote: "The first step is to establish that something is possible; then probability will occur.", author: "Elon Musk" },
    { id: 10015, quote: "If you get up in the morning and think the future is going to be better, it is a bright day.", author: "Elon Musk" },
    { id: 10016, quote: "Failure is an option here. If things are not failing, you are not innovating enough.", author: "Elon Musk" },
    { id: 10017, quote: "I would like to die on Mars. Just not on impact.", author: "Elon Musk" },
    { id: 10018, quote: "Some people don't like change, but you need to embrace change if the alternative is disaster.", author: "Elon Musk" },
    { id: 10019, quote: "Take risks now. Do something bold. You won't regret it.", author: "Elon Musk" },
    { id: 10020, quote: "If something's important enough, you should try. Even if the probable outcome is failure.", author: "Elon Musk" },
    
    // Steve Jobs (Apple Co-founder)
    { id: 10021, quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
    { id: 10022, quote: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs" },
    { id: 10023, quote: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
    { id: 10024, quote: "Stay hungry. Stay foolish.", author: "Steve Jobs" },
    { id: 10025, quote: "Design is not just what it looks like. Design is how it works.", author: "Steve Jobs" },
    { id: 10026, quote: "Sometimes life hits you in the head with a brick. Don't lose faith.", author: "Steve Jobs" },
    { id: 10027, quote: "The people who are crazy enough to think they can change the world are the ones who do.", author: "Steve Jobs" },
    { id: 10028, quote: "Simple can be harder than complex.", author: "Steve Jobs" },
    { id: 10029, quote: "Don't let the noise of others' opinions drown out your own inner voice.", author: "Steve Jobs" },
    { id: 10030, quote: "I want to put a ding in the universe.", author: "Steve Jobs" },
    
    // Bill Gates (Microsoft Co-founder)
    { id: 10031, quote: "Your most unhappy customers are your greatest source of learning.", author: "Bill Gates" },
    { id: 10032, quote: "It's fine to celebrate success, but it is more important to heed the lessons of failure.", author: "Bill Gates" },
    { id: 10033, quote: "If you can't make it good, at least make it look good.", author: "Bill Gates" },
    { id: 10034, quote: "Success is a lousy teacher. It seduces smart people into thinking they can't lose.", author: "Bill Gates" },
    { id: 10035, quote: "We always overestimate the change that will occur in the next two years.", author: "Bill Gates" },
    
    // Jeff Bezos (Amazon Founder)
    { id: 10036, quote: "I knew that if I failed I wouldn't regret that, but I knew the one thing I might regret is not trying.", author: "Jeff Bezos" },
    { id: 10037, quote: "Life's too short to hang out with people who aren't resourceful.", author: "Jeff Bezos" },
    { id: 10038, quote: "If you're not stubborn, you'll give up on experiments too soon.", author: "Jeff Bezos" },
    { id: 10039, quote: "Work hard, have fun, make history.", author: "Jeff Bezos" },
    { id: 10040, quote: "What's dangerous is not to evolve.", author: "Jeff Bezos" },
    
    // Sundar Pichai (Google CEO)
    { id: 10041, quote: "Wear your failure as a badge of honor.", author: "Sundar Pichai" },
    { id: 10042, quote: "It is important to follow your dreams and heart. Do something that excites you.", author: "Sundar Pichai" },
    { id: 10043, quote: "As a leader, it is important to not just see your own success, but focus on the success of others.", author: "Sundar Pichai" },
    { id: 10044, quote: "Let yourself feel insecure from time to time. It forces you to work harder.", author: "Sundar Pichai" },
    
    // Mark Zuckerberg (Meta CEO)
    { id: 10045, quote: "The biggest risk is not taking any risk.", author: "Mark Zuckerberg" },
    { id: 10046, quote: "Move fast and break things. Unless you are breaking stuff, you are not moving fast enough.", author: "Mark Zuckerberg" },
    { id: 10047, quote: "Ideas don't come out fully formed. They only become clear as you work on them.", author: "Mark Zuckerberg" },
    { id: 10048, quote: "The question isn't, 'What do we want to know about people?' It's, 'What do people want to tell about themselves?'", author: "Mark Zuckerberg" },
    
    // Warren Buffett (Berkshire Hathaway CEO)
    { id: 10049, quote: "Price is what you pay. Value is what you get.", author: "Warren Buffett" },
    { id: 10050, quote: "It takes 20 years to build a reputation and five minutes to ruin it.", author: "Warren Buffett" },
    { id: 10051, quote: "Risk comes from not knowing what you're doing.", author: "Warren Buffett" },
    { id: 10052, quote: "The stock market is designed to transfer money from the Active to the Patient.", author: "Warren Buffett" },
    { id: 10053, quote: "Someone's sitting in the shade today because someone planted a tree a long time ago.", author: "Warren Buffett" },
    
    // Ancient Sages & Philosophers
    { id: 10054, quote: "The only true wisdom is in knowing you know nothing.", author: "Socrates" },
    { id: 10055, quote: "No man ever steps in the same river twice.", author: "Heraclitus" },
    { id: 10056, quote: "The whole is greater than the sum of its parts.", author: "Aristotle" },
    { id: 10057, quote: "I think, therefore I am.", author: "Ren√© Descartes" },
    { id: 10058, quote: "The unexamined life is not worth living.", author: "Socrates" },
    { id: 10059, quote: "To be yourself in a world that is constantly trying to make you something else is the greatest accomplishment.", author: "Ralph Waldo Emerson" },
    { id: 10060, quote: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
    { id: 10061, quote: "He who knows others is wise; he who knows himself is enlightened.", author: "Lao Tzu" },
    { id: 10062, quote: "When you realize nothing is lacking, the whole world belongs to you.", author: "Lao Tzu" },
    { id: 10063, quote: "The mind is everything. What you think you become.", author: "Buddha" },
    { id: 10064, quote: "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.", author: "Buddha" },
    { id: 10065, quote: "Three things cannot be long hidden: the sun, the moon, and the truth.", author: "Buddha" },
    
    // Satya Nadella (Microsoft CEO)
    { id: 10066, quote: "Our industry does not respect tradition ‚Äî it only respects innovation.", author: "Satya Nadella" },
    { id: 10067, quote: "Empathy is at the core of everything we do.", author: "Satya Nadella" },
    { id: 10068, quote: "Don't be a know-it-all, be a learn-it-all.", author: "Satya Nadella" },
    
    // Jensen Huang (NVIDIA CEO)
    { id: 10069, quote: "The more you buy, the more you save.", author: "Jensen Huang" },
    { id: 10070, quote: "Either you're running for food, or you are running from being food.", author: "Jensen Huang" },
    
    // Peter Thiel (PayPal Co-founder)
    { id: 10071, quote: "Competition is for losers.", author: "Peter Thiel" },
    { id: 10072, quote: "The most contrarian thing of all is not to oppose the crowd but to think for yourself.", author: "Peter Thiel" },
    { id: 10073, quote: "Every moment in business happens only once.", author: "Peter Thiel" },
    
    // Naval Ravikant (AngelList Founder)
    { id: 10074, quote: "Seek wealth, not money or status. Wealth is having assets that earn while you sleep.", author: "Naval Ravikant" },
    { id: 10075, quote: "Play long-term games with long-term people.", author: "Naval Ravikant" },
    { id: 10076, quote: "Specific knowledge is found by pursuing your genuine curiosity.", author: "Naval Ravikant" },
    { id: 10077, quote: "The most important skill for getting rich is becoming a perpetual learner.", author: "Naval Ravikant" },
    { id: 10078, quote: "A fit body, a calm mind, a house full of love. These things cannot be bought ‚Äî they must be earned.", author: "Naval Ravikant" }
];

// ============================================
// ZEN BACKGROUND SYSTEM
// ============================================

class ZenBackground {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.particles = [];
        this.time = 0;
        this.resize();
        window.addEventListener('resize', () => this.resize());
    }
    
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    initParticles() {
        this.particles = [];
        const count = Math.floor((this.canvas.width * this.canvas.height) / 15000);
        for (let i = 0; i < count; i++) {
            this.particles.push({
                x: Math.random() * this.canvas.width,
                y: Math.random() * this.canvas.height,
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                size: Math.random() * 2 + 1,
                opacity: Math.random() * 0.5 + 0.2
            });
        }
    }
    
    drawParticles() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const accentColor = getComputedStyle(document.documentElement)
            .getPropertyValue('--accent-color').trim();
        
        this.particles.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            
            if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
            if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
            
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fillStyle = this.hexToRgba(accentColor, p.opacity);
            this.ctx.fill();
        });
    }
    
    drawWaves() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const accentColor = getComputedStyle(document.documentElement)
            .getPropertyValue('--accent-color').trim();
        
        for (let i = 0; i < 3; i++) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, this.canvas.height / 2);
            
            for (let x = 0; x < this.canvas.width; x += 5) {
                const y = Math.sin((x + this.time * (i + 1) * 0.5) * 0.01) * 50 + 
                          this.canvas.height / 2 + i * 100;
                this.ctx.lineTo(x, y);
            }
            
            this.ctx.strokeStyle = this.hexToRgba(accentColor, 0.1 + i * 0.05);
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        }
        
        this.time += 0.5;
    }
    
    drawCircles() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const accentColor = getComputedStyle(document.documentElement)
            .getPropertyValue('--accent-color').trim();
        
        const centerX = this.canvas.width / 2;
        const centerY = this.canvas.height / 2;
        
        for (let i = 1; i <= 5; i++) {
            const radius = 50 + i * 80 + Math.sin(this.time * 0.01 + i) * 20;
            
            this.ctx.beginPath();
            this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            this.ctx.strokeStyle = this.hexToRgba(accentColor, 0.15 - i * 0.02);
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        }
        
        this.time += 0.5;
    }
    
    hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    animate(style) {
        if (style === 'particles') {
            this.drawParticles();
        } else if (style === 'waves') {
            this.drawWaves();
        } else if (style === 'circles') {
            this.drawCircles();
        }
    }
}

let zenBackground = null;

function initZenBackground() {
    if (!zenBackground) {
        zenBackground = new ZenBackground(zenCanvas);
        zenBackground.initParticles();
    }
}

function startZenAnimation() {
    if (!zenEnabled) return;
    
    function animate() {
        if (!zenEnabled) {
            cancelAnimationFrame(zenAnimationId);
            return;
        }
        
        zenBackground.animate(zenCurrentStyle);
        zenAnimationId = requestAnimationFrame(animate);
    }
    
    zenCanvas.classList.add('active');
    animate();
}

function stopZenAnimation() {
    zenEnabled = false;
    if (zenAnimationId) {
        cancelAnimationFrame(zenAnimationId);
        zenAnimationId = null;
    }
    zenCanvas.classList.remove('active');
}

zenToggle.addEventListener('change', (e) => {
    zenEnabled = e.target.checked;
    localStorage.setItem('zenEnabled', zenEnabled);
    
    if (zenEnabled) {
        initZenBackground();
        startZenAnimation();
    } else {
        stopZenAnimation();
    }
});

zenStyle.addEventListener('change', (e) => {
    zenCurrentStyle = e.target.value;
    localStorage.setItem('zenStyle', zenCurrentStyle);
    
    if (zenCurrentStyle === 'particles' && zenEnabled) {
        zenBackground.initParticles();
    }
});

const savedZenEnabled = localStorage.getItem('zenEnabled') === 'true';
const savedZenStyle = localStorage.getItem('zenStyle') || 'particles';
zenToggle.checked = savedZenEnabled;
zenEnabled = savedZenEnabled;
zenStyle.value = savedZenStyle;
zenCurrentStyle = savedZenStyle;

if (zenEnabled) {
    initZenBackground();
    startZenAnimation();
}

// ============================================
// STORY CARD GENERATOR
// ============================================

function generateStoryCard() {
    const ctx = storyCardCanvas.getContext('2d');
    const width = 1080;
    const height = 1920;
    
    const bgColor = getComputedStyle(document.documentElement)
        .getPropertyValue('--bg-primary').trim();
    const textColor = getComputedStyle(document.documentElement)
        .getPropertyValue('--text-primary').trim();
    const accentColor = getComputedStyle(document.documentElement)
        .getPropertyValue('--accent-color').trim();
    
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, width, height);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, hexToRgba(accentColor, 0.05));
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    const quote = quoteText.textContent;
    const authorName = quoteAuthor.querySelector('[itemprop="name"]')?.textContent || 'Unknown';
    
    ctx.fillStyle = hexToRgba(accentColor, 0.3);
    ctx.font = 'bold 120px Arial';
    ctx.fillText('"', 100, 250);
    
    ctx.fillStyle = textColor;
    ctx.font = '600 64px Inter, sans-serif';
    ctx.textAlign = 'left';
    
    const maxWidth = width - 200;
    const lineHeight = 90;
    const words = quote.split(' ');
    let line = '';
    let y = 400;
    
    for (let word of words) {
        const testLine = line + word + ' ';
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && line !== '') {
            ctx.fillText(line, 100, y);
            line = word + ' ';
            y += lineHeight;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 100, y);
    
    ctx.fillStyle = accentColor;
    ctx.font = '500 48px Inter, sans-serif';
    ctx.fillText('‚Äî ' + authorName, 100, y + 120);
    
    ctx.fillStyle = hexToRgba(textColor, 0.5);
    ctx.font = '400 36px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‚ú® Quote Galaxy', width / 2, height - 100);
    
    storyCardModal.classList.remove('hidden');
}

function hexToRgba(hex, alpha) {
    if (hex.startsWith('rgba')) {
        return hex.replace(/[\d.]+\)$/g, `${alpha})`);
    }
    
    hex = hex.replace('#', '');
    if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
    }
    
    const r = parseInt(hex.slice(0, 2), 16);
    const g = parseInt(hex.slice(2, 4), 16);
    const b = parseInt(hex.slice(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

storyCardBtn.addEventListener('click', generateStoryCard);

closeStoryModal.addEventListener('click', () => {
    storyCardModal.classList.add('hidden');
});

downloadStoryBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'quote-story.png';
    link.href = storyCardCanvas.toDataURL('image/png');
    link.click();
});
// ============================================
// AUTHORS SYSTEM
// ============================================

function getTopAuthors() {
    const authorCounts = {};
    
    allQuotes.forEach(quote => {
        const author = quote.author;
        if (authorCounts[author]) {
            authorCounts[author]++;
        } else {
            authorCounts[author] = 1;
        }
    });
    
    const sortedAuthors = Object.entries(authorCounts)
        .filter(([author, count]) => count >= 5)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 50)
        .map(([author, count]) => ({ name: author, count: count }));
    
    return sortedAuthors;
}

function displayAuthors() {
    topAuthors = getTopAuthors();
    authorsGrid.innerHTML = '';
    
    topAuthors.forEach(author => {
        const initials = author.name.split(' ').map(n => n[0]).join('').slice(0, 2);
        
        const authorCard = document.createElement('button');
        authorCard.className = 'author-card bg-secondary bg-hover border border-custom rounded-xl p-6 text-center';
        authorCard.setAttribute('data-author', author.name);
        
        authorCard.innerHTML = `
            <div class="w-16 h-16 mx-auto mb-3 rounded-full accent-bg flex items-center justify-center text-2xl font-bold text-white">
                ${initials}
            </div>
            <h3 class="font-semibold mb-1 text-sm">${author.name}</h3>
            <p class="text-xs text-secondary">${author.count} quotes</p>
        `;
        
        authorCard.addEventListener('click', () => {
            currentAuthor = author.name;
            currentCategory = '';
            currentJourney = null;
            shownQuoteIds = [];
            showQuoteSection();
            showQuotesByAuthor();
        });
        
        authorsGrid.appendChild(authorCard);
    });
}

function showQuotesByAuthor() {
    const authorQuotes = allQuotes.filter(q => q.author === currentAuthor);
    
    if (authorQuotes.length === 0) {
        quoteText.textContent = 'No quotes found for this author.';
        quoteAuthor.textContent = '';
        return;
    }
    
    const availableQuotes = authorQuotes.filter(q => !shownQuoteIds.includes(q.id));
    
    if (availableQuotes.length === 0) {
        shownQuoteIds = [];
        return showQuotesByAuthor();
    }
    
    const randomIndex = Math.floor(Math.random() * availableQuotes.length);
    const selectedQuote = availableQuotes[randomIndex];
    
    shownQuoteIds.push(selectedQuote.id);
    displayQuote(selectedQuote);
}
// ============================================
// TRANSLATION FUNCTIONS
// ============================================

async function translateText(text, targetLang) {
    if (targetLang === 'en') return text;
    
    const cacheKey = `translation_${text}_${targetLang}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) return cached;
    
    try {
        const sourceLang = 'en';
        const langPair = `${sourceLang}|${languageCodes[targetLang]}`;
        const encodedText = encodeURIComponent(text);
        const apiUrl = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${langPair}`;
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData.translatedText) {
            const translated = data.responseData.translatedText;
            try {
                localStorage.setItem(cacheKey, translated);
            } catch (e) {
                clearOldTranslations();
            }
            return translated;
        }
        
        return text;
    } catch (error) {
        console.log('Translation error:', error);
        return text;
    }
}

function clearOldTranslations() {
    const keys = Object.keys(localStorage);
    const translationKeys = keys.filter(k => k.startsWith('translation_'));
    const toRemove = translationKeys.slice(0, Math.floor(translationKeys.length / 2));
    toRemove.forEach(key => localStorage.removeItem(key));
}

// ============================================
// PWA INSTALL
// ============================================

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.classList.remove('hidden');
});

installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') installBtn.classList.add('hidden');
    deferredPrompt = null;
});

window.addEventListener('appinstalled', () => {
    installBtn.classList.add('hidden');
    statusMessage.innerHTML = '<i class="fas fa-check mr-2"></i>App installed!';
});

// ============================================
// DEVICE DETECTION
// ============================================

function detectDevice() {
    const ua = navigator.userAgent;
    let deviceType = 'Desktop', os = 'Unknown', browser = 'Unknown';
    
    if (/mobile/i.test(ua)) deviceType = 'Mobile';
    else if (/tablet|ipad/i.test(ua)) deviceType = 'Tablet';
    
    if (/windows/i.test(ua)) os = 'Windows';
    else if (/mac/i.test(ua)) os = 'macOS';
    else if (/linux/i.test(ua)) os = 'Linux';
    else if (/android/i.test(ua)) os = 'Android';
    else if (/iphone|ipad|ipod/i.test(ua)) os = 'iOS';
    
    if (/firefox/i.test(ua)) browser = 'Firefox';
    else if (/chrome/i.test(ua) && !/edg/i.test(ua)) browser = 'Chrome';
    else if (/safari/i.test(ua) && !/chrome/i.test(ua)) browser = 'Safari';
    else if (/edg/i.test(ua)) browser = 'Edge';
    else if (/opera|opr/i.test(ua)) browser = 'Opera';
    
    document.getElementById('device-type').textContent = `Type: ${deviceType}`;
    document.getElementById('device-os').textContent = `OS: ${os}`;
    document.getElementById('device-browser').textContent = `Browser: ${browser}`;
    
    if (deviceType === 'Mobile') document.body.classList.add('mobile-layout');
    
    return { deviceType, os, browser };
}

// ============================================
// THEME SYSTEM
// ============================================

function setTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('theme', themeName);
    
    const themeColorMeta = document.querySelector('meta[name="theme-color"]');
    if (themeColorMeta) {
        const computedColor = getComputedStyle(document.documentElement)
            .getPropertyValue('--accent-color').trim();
        themeColorMeta.setAttribute('content', computedColor);
    }
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'vscode-dark';
    setTheme(savedTheme);
}

// ============================================
// LANGUAGE SYSTEM
// ============================================

async function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    document.documentElement.setAttribute('lang', lang);
    
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });
    
    if (currentQuoteData && !quoteSection.classList.contains('hidden')) {
        await displayQuote(currentQuoteData, true);
    }
}

function detectLanguage() {
    const browserLang = navigator.language.split('-')[0];
    const savedLang = localStorage.getItem('language');
    return savedLang || (translations[browserLang] ? browserLang : 'en');
}

// ============================================
// VOICE SYNTHESIS
// ============================================

function speakQuote() {
    if (!speechSynthesis) {
        statusMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Voice not supported';
        return;
    }
    
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        voiceBtn.classList.remove('voice-active');
        statusMessage.innerHTML = '<i class="fas fa-stop mr-2"></i>' + translations[currentLanguage].stopped;
        return;
    }
    
    const quote = quoteText.textContent;
    const author = quoteAuthor.textContent;
    const textToSpeak = `${quote}. ${author}`;
    
    currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
    currentUtterance.lang = currentLanguage === 'en' ? 'en-US' : 
                           currentLanguage === 'hi' ? 'hi-IN' :
                           currentLanguage === 'es' ? 'es-ES' :
                           currentLanguage === 'fr' ? 'fr-FR' :
                           currentLanguage === 'de' ? 'de-DE' :
                           currentLanguage === 'ja' ? 'ja-JP' :
                           currentLanguage === 'zh' ? 'zh-CN' : 'en-US';
    
    currentUtterance.rate = 0.9;
    currentUtterance.pitch = 1.0;
    currentUtterance.volume = 1.0;
    
    currentUtterance.onstart = () => {
        voiceBtn.classList.add('voice-active');
        statusMessage.innerHTML = '<i class="fas fa-volume-high mr-2"></i>' + translations[currentLanguage].reading;
    };
    
    currentUtterance.onend = () => {
        voiceBtn.classList.remove('voice-active');
        statusMessage.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${shownQuoteIds.length} ${translations[currentLanguage].viewed}`;
    };
    
    currentUtterance.onerror = () => {
        voiceBtn.classList.remove('voice-active');
        statusMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Voice error';
    };
    
    speechSynthesis.speak(currentUtterance);
}

// ============================================
// LOCAL STORAGE FUNCTIONS
// ============================================

function saveQuotesToCache(quotes) {
    try {
        localStorage.setItem('allQuotes', JSON.stringify(quotes));
    } catch (error) {
        console.log('Could not save to cache:', error);
    }
}

function getCachedQuotes() {
    try {
        const cached = localStorage.getItem('allQuotes');
        return cached ? JSON.parse(cached) : [];
    } catch (error) {
        return [];
    }
}

function saveShownQuotes() {
    try {
        const key = currentAuthor ? `shownQuotes_author_${currentAuthor}` : `shownQuotes_${currentCategory}`;
        localStorage.setItem(key, JSON.stringify(shownQuoteIds));
    } catch (error) {
        console.log('Could not save shown quotes:', error);
    }
}

function loadShownQuotes() {
    try {
        const key = currentAuthor ? `shownQuotes_author_${currentAuthor}` : `shownQuotes_${currentCategory}`;
        const shown = localStorage.getItem(key);
        shownQuoteIds = shown ? JSON.parse(shown) : [];
    } catch (error) {
        shownQuoteIds = [];
    }
}

// ============================================
// JOURNEY SYSTEM
// ============================================

function startJourney(journeyType) {
    const journey = journeyDefinitions[journeyType];
    if (!journey || allQuotes.length === 0) return;
    
    currentJourney = journeyType;
    journeyQuotes = [];
    journeyCurrentIndex = 0;
    
    journey.keywords.forEach(keyword => {
        const matching = allQuotes.filter(q => quoteMatchesCategory(q, keyword));
        if (matching.length > 0) {
            const random = matching[Math.floor(Math.random() * matching.length)];
            journeyQuotes.push(random);
        }
    });
    
    while (journeyQuotes.length < 5) {
        const random = allQuotes[Math.floor(Math.random() * allQuotes.length)];
        if (!journeyQuotes.find(q => q.id === random.id)) {
            journeyQuotes.push(random);
        }
    }
    
    journeyQuotes = journeyQuotes.slice(0, 5);
    
    journeyProgressContainer.classList.remove('hidden');
    journeyTitle.textContent = journey.title;
    
    showQuoteSection();
    displayQuote(journeyQuotes[0]);
    updateJourneyProgress();
}

function updateJourneyProgress() {
    const current = journeyCurrentIndex + 1;
    const total = journeyQuotes.length;
    const percentage = (current / total) * 100;
    
    journeyStep.textContent = `${current} / ${total}`;
    journeyProgressBar.style.width = `${percentage}%`;
}

function nextJourneyQuote() {
    journeyCurrentIndex++;
    
    if (journeyCurrentIndex >= journeyQuotes.length) {
        statusMessage.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + translations[currentLanguage].journeyComplete;
        journeyProgressContainer.classList.add('hidden');
        currentJourney = null;
        return;
    }
    
    displayQuote(journeyQuotes[journeyCurrentIndex]);
    updateJourneyProgress();
}
// ============================================
// QUOTE FETCHING FUNCTIONS
// ============================================

async function fetchAllQuotes() {
    try {
        quoteText.textContent = translations[currentLanguage].loading;
        quoteAuthor.textContent = '';
        statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + translations[currentLanguage].loading;
        
        // Array to store all quotes from multiple APIs
        let combinedQuotes = [];
        
        // API 1: DummyJSON (1454 quotes)
        try {
            const response1 = await fetch('https://dummyjson.com/quotes?limit=0');
            if (response1.ok) {
                const data1 = await response1.json();
                combinedQuotes = combinedQuotes.concat(data1.quotes);
                console.log('‚úÖ DummyJSON: Loaded', data1.quotes.length, 'quotes');
            }
        } catch (err) {
            console.log('‚ö†Ô∏è DummyJSON failed:', err);
        }
        
        // API 2: Quotable.io (2000+ quotes)
        try {
            let quotablePage = 1;
            let hasMore = true;
            
            while (hasMore && quotablePage <= 15) {  // Limit to 15 pages = ~300 quotes
                const response2 = await fetch(`https://api.quotable.io/quotes?page=${quotablePage}&limit=20`);
                if (response2.ok) {
                    const data2 = await response2.json();
                    
                    // Convert format to match DummyJSON
                    const formattedQuotes = data2.results.map((q, index) => ({
                        id: 1500 + (quotablePage * 20) + index,  // Unique IDs starting from 1500
                        quote: q.content,
                        author: q.author
                    }));
                    
                    combinedQuotes = combinedQuotes.concat(formattedQuotes);
                    
                    hasMore = data2.totalPages > quotablePage;
                    quotablePage++;
                } else {
                    hasMore = false;
                }
            }
            console.log('‚úÖ Quotable.io: Loaded quotes');
        } catch (err) {
            console.log('‚ö†Ô∏è Quotable.io failed:', err);
        }
        
        // API 3: ZenQuotes (50 quotes - small but good quality)
        try {
            const response3 = await fetch('https://zenquotes.io/api/quotes');
            if (response3.ok) {
                const data3 = await response3.json();
                
                // Convert format to match DummyJSON
                const formattedQuotes = data3.map((q, index) => ({
                    id: 2000 + index,  // Unique IDs starting from 2000
                    quote: q.q,
                    author: q.a
                }));
                
                combinedQuotes = combinedQuotes.concat(formattedQuotes);
                console.log('‚úÖ ZenQuotes: Loaded', formattedQuotes.length, 'quotes');
            }
        } catch (err) {
            console.log('‚ö†Ô∏è ZenQuotes failed:', err);
        }
        
        // Remove duplicates based on quote text
        const uniqueQuotes = [];
        const seenQuotes = new Set();
        
        combinedQuotes.forEach(quote => {
            const normalizedQuote = quote.quote.toLowerCase().trim();
            if (!seenQuotes.has(normalizedQuote)) {
                seenQuotes.add(normalizedQuote);
                uniqueQuotes.push(quote);
            }
        });
        
        allQuotes = uniqueQuotes;

        // Add curated CEO & Sage quotes
        allQuotes = allQuotes.concat(curatedQuotes);
        
        console.log('üéâ Total unique quotes loaded:', allQuotes.length);
        
        if (allQuotes.length === 0) {
            throw new Error('No quotes loaded from any API');
        }
        
        saveQuotesToCache(allQuotes);
        showQuoteFromCategory();
        
        statusMessage.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${allQuotes.length} quotes loaded`;
        
    } catch (error) {
        console.log('‚ùå All APIs failed:', error);
        loadCachedQuotes();
    }
}

function loadCachedQuotes() {
    const cached = getCachedQuotes();
    
    if (cached.length > 0) {
        allQuotes = cached;
        showQuoteFromCategory();
        statusMessage.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>' + translations[currentLanguage].offline;
    } else {
        quoteText.textContent = 'Unable to load quotes. Please check your internet connection.';
        quoteAuthor.textContent = '';
        statusMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>No cached quotes';
    }
}

function quoteMatchesCategory(quote, category) {
    if (category === 'all') return true;
    
    const keywords = categoryKeywords[category] || [category];
    const quoteText = quote.quote.toLowerCase();
    
    return keywords.some(keyword => quoteText.includes(keyword.toLowerCase()));
}

function showQuoteFromCategory() {
    let filteredQuotes;
    
    if (currentCategory === 'all') {
        filteredQuotes = allQuotes;
    } else {
        filteredQuotes = allQuotes.filter(q => quoteMatchesCategory(q, currentCategory));
        
        if (filteredQuotes.length < 10) {
            filteredQuotes = allQuotes;
            statusMessage.innerHTML = '<i class="fas fa-sparkles mr-2"></i>Showing all quotes for variety';
        }
    }
    
    const availableQuotes = filteredQuotes.filter(q => !shownQuoteIds.includes(q.id));
    
    if (availableQuotes.length === 0) {
        shownQuoteIds = [];
        saveShownQuotes();
        return showQuoteFromCategory();
    }
    
    const randomIndex = Math.floor(Math.random() * availableQuotes.length);
    const selectedQuote = availableQuotes[randomIndex];
    
    shownQuoteIds.push(selectedQuote.id);
    saveShownQuotes();
    
    displayQuote(selectedQuote);
}

async function displayQuote(quote, isLanguageSwitch = false) {
    currentQuoteData = quote;
    
    quoteContainer.classList.remove('quote-reveal');
    void quoteContainer.offsetWidth;
    quoteContainer.classList.add('quote-reveal');
    
    if (currentLanguage !== 'en') {
        statusMessage.innerHTML = '<i class="fas fa-language mr-2"></i>' + translations[currentLanguage].translating;
    }
    
    const translatedQuote = await translateText(quote.quote, currentLanguage);
    const translatedAuthor = await translateText(quote.author, currentLanguage);
    
    quoteText.textContent = translatedQuote;
    
    const authorSpan = quoteAuthor.querySelector('[itemprop="name"]');
    if (authorSpan) authorSpan.textContent = translatedAuthor;
    
    statusMessage.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${shownQuoteIds.length} ${translations[currentLanguage].viewed}`;
    
    updateMetaTags({ quote: translatedQuote, author: translatedAuthor });
}

function updateMetaTags(quote) {
    const ogTitle = document.querySelector('meta[property="og:title"]');
    const ogDescription = document.querySelector('meta[property="og:description"]');
    const twitterTitle = document.querySelector('meta[property="twitter:title"]');
    const twitterDescription = document.querySelector('meta[property="twitter:description"]');
    
    const shareText = `"${quote.quote}" ‚Äî ${quote.author}`;
    
    if (ogTitle) ogTitle.setAttribute('content', `${shareText} | Quote Galaxy`);
    if (ogDescription) ogDescription.setAttribute('content', shareText);
    if (twitterTitle) twitterTitle.setAttribute('content', `${shareText} | Quote Galaxy`);
    if (twitterDescription) twitterDescription.setAttribute('content', shareText);
}

// ============================================
// USER INTERFACE FUNCTIONS
// ============================================

function showQuoteSection() {
    document.getElementById('bellBtn').style.display = 'none'; // Hide bell button
    mainMenu.classList.add('hidden');
    categoriesSection.classList.add('hidden');
    authorsSection.classList.add('hidden');
    philosophySection.classList.add('hidden');
    quoteSection.classList.remove('hidden');
    quoteSection.classList.add('fade-enter');
    backBtn.focus();
}

function showMainMenu() {
    document.getElementById('bellBtn').style.display = 'flex'; // Show bell button
    quoteSection.classList.add('hidden');
    categoriesSection.classList.add('hidden');
    authorsSection.classList.add('hidden');
    philosophySection.classList.add('hidden');
    mainMenu.classList.remove('hidden');
    
    journeyProgressContainer.classList.add('hidden');
    currentJourney = null;
    currentAuthor = '';
    
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        voiceBtn.classList.remove('voice-active');
    }
}

function showCategoriesSection() {
    document.getElementById('bellBtn').style.display = 'none';
    mainMenu.classList.add('hidden');
    quoteSection.classList.add('hidden');
    authorsSection.classList.add('hidden');
    philosophySection.classList.add('hidden');
    categoriesSection.classList.remove('hidden');
}

function showAuthorsSection() {
    document.getElementById('bellBtn').style.display = 'none';
    mainMenu.classList.add('hidden');
    quoteSection.classList.add('hidden');
    categoriesSection.classList.add('hidden');
   philosophySection.classList.add('hidden');
    authorsSection.classList.remove('hidden');
    
    if (allQuotes.length > 0) {
            displayAuthors();
    } else {
        // Fetch quotes first if not loaded
        fetchAllQuotes().then(() => {
            displayAuthors();
        });
    }
}



function showPhilosophySection() {
    mainMenu.classList.add('hidden');
    quoteSection.classList.add('hidden');
    categoriesSection.classList.add('hidden');
    authorsSection.classList.add('hidden');
    philosophySection.classList.remove('hidden');
}


function toggleSettings() {
    settingsPanel.classList.toggle('open');
    if (settingsPanel.classList.contains('open')) {
        closeSettingsBtn.focus();
    }
}

function shareQuote() {
    const quote = quoteText.textContent;
    const authorName = quoteAuthor.querySelector('[itemprop="name"]')?.textContent || 'Unknown';
    const shareText = `"${quote}"\n‚Äî ${authorName}\n\n‚ú® From Quote Galaxy\n${window.location.href}`;
    const shareTitle = 'Inspirational Quote';
    
    if (navigator.share) {
        navigator.share({
            title: shareTitle,
            text: shareText,
            url: window.location.href
        }).catch(err => console.log('Share cancelled'));
    } else {
        navigator.clipboard.writeText(shareText).then(() => {
            const tempStatus = statusMessage.innerHTML;
            statusMessage.innerHTML = '<i class="fas fa-check mr-2"></i>' + translations[currentLanguage].copied;
            setTimeout(() => {
                statusMessage.innerHTML = tempStatus;
            }, 2000);
        }).catch(() => {
            statusMessage.innerHTML = '<i class="fas fa-times mr-2"></i>Could not copy';
        });
    }
}

// ============================================
// KEYBOARD NAVIGATION
// ============================================

document.addEventListener('keydown', (e) => {
    easterEggInput += e.key.toLowerCase();
    if (easterEggInput.length > 10) {
        easterEggInput = easterEggInput.slice(-10);
    }
    
    if (easterEggInput.includes('rainbow')) {
        setTheme('rainbow');
        easterEggInput = '';
    } else if (easterEggInput.includes('matrix')) {
        setTheme('matrix');
        easterEggInput = '';
    } else if (easterEggInput.includes('retro')) {
        setTheme('retro');
        easterEggInput = '';
    }
    
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
        return;
    }
    
    if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        toggleSettings();
    }
    
    if (e.key === 'Escape') {
        e.preventDefault();
        if (settingsPanel.classList.contains('open')) {
            toggleSettings();
        } else if (storyCardModal.classList.contains('hidden') === false) {
            storyCardModal.classList.add('hidden');
        } else if (!quoteSection.classList.contains('hidden')) {
            if (currentJourney) {
                showJourneysSection();
            } else if (currentAuthor) {
                showAuthorsSection();
            } else {
                showMainMenu();
            }
        } else if (!categoriesSection.classList.contains('hidden')) {
            showMainMenu();
        } else if (!journeysSection.classList.contains('hidden')) {
            showMainMenu();
        } else if (!authorsSection.classList.contains('hidden')) {
            showMainMenu();
        }
    }
    
    if ((e.key === 'b' || e.key === 'B') && !quoteSection.classList.contains('hidden')) {
        e.preventDefault();
        if (currentJourney) {
            showJourneysSection();
        } else if (currentAuthor) {
            showAuthorsSection();
        } else {
            showMainMenu();
        }
    }
    
    if ((e.key === ' ' || e.key === 'n' || e.key === 'N') && !quoteSection.classList.contains('hidden')) {
        e.preventDefault();
        if (currentJourney) {
            nextJourneyQuote();
        } else if (currentAuthor) {
            showQuotesByAuthor();
        } else if (allQuotes.length > 0) {
            showQuoteFromCategory();
        } else {
            fetchAllQuotes();
        }
    }
    
    if ((e.key === 'c' || e.key === 'C') && !quoteSection.classList.contains('hidden')) {
        e.preventDefault();
        shareQuote();
    }
    
    if ((e.key === 'v' || e.key === 'V') && !quoteSection.classList.contains('hidden')) {
        e.preventDefault();
        speakQuote();
    }
    
    if ((e.key === 'i' || e.key === 'I') && !quoteSection.classList.contains('hidden')) {
        e.preventDefault();
        generateStoryCard();
    }
    
    if (!quoteSection.classList.contains('hidden')) return;
    
    const numKey = parseInt(e.key);
    if (numKey >= 1 && numKey <= 9) {
        e.preventDefault();
        const buttons = Array.from(categoryButtons);
        if (buttons[numKey - 1]) {
            buttons[numKey - 1].click();
        }
    }
});
// ============================================
// EVENT LISTENERS
// ============================================

browseCategoriesBtn.addEventListener('click', showCategoriesSection);
browseAuthorsBtn.addEventListener('click', showAuthorsSection);
browsePhilosophyBtn.addEventListener('click', showPhilosophySection);
backToMenuFromCategories.addEventListener('click', showMainMenu);
backToMenuFromAuthors.addEventListener('click', showMainMenu);
backToMenuFromPhilosophy.addEventListener('click', showMainMenu);

categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
        currentCategory = button.getAttribute('data-category');
        currentAuthor = '';
        loadShownQuotes();
        showQuoteSection();
        
        if (allQuotes.length > 0) {
            showQuoteFromCategory();
        } else {
            fetchAllQuotes();
        }
    });
});

philosophyButtons.forEach((button) => {
    button.addEventListener('click', () => {
        currentCategory = button.getAttribute('data-philosophy');
        currentAuthor = '';
        loadShownQuotes();
        showQuoteSection();
        
        if (allQuotes.length > 0) {
            showQuoteFromCategory();
        } else {
            fetchAllQuotes();
        }
    });
});


journeyCards.forEach((card) => {
    card.addEventListener('click', () => {
        const journeyType = card.getAttribute('data-journey');
        startJourney(journeyType);
    });
});

backBtn.addEventListener('click', () => {
    if (currentJourney) {
        showJourneysSection();
    } else if (currentAuthor) {
        showAuthorsSection();
    } else {
        showMainMenu();
    }
});

newQuoteBtn.addEventListener('click', () => {
    if (currentJourney) {
        nextJourneyQuote();
    } else if (currentAuthor) {
        showQuotesByAuthor();
    } else if (allQuotes.length > 0) {
        showQuoteFromCategory();
    } else {
        fetchAllQuotes();
    }
});

shareBtn.addEventListener('click', shareQuote);
voiceBtn.addEventListener('click', speakQuote);
settingsBtn.addEventListener('click', toggleSettings);
closeSettingsBtn.addEventListener('click', toggleSettings);

themeButtons.forEach(button => {
    button.addEventListener('click', () => {
        const theme = button.getAttribute('data-theme');
        setTheme(theme);
    });
});

languageSelect.addEventListener('change', (e) => {
    setLanguage(e.target.value);
});

// ============================================
// URL PARAMETER HANDLING
// ============================================

function handleURLParams() {
    const params = new URLSearchParams(window.location.search);
    const category = params.get('category');
    
    if (category && categoryKeywords[category]) {
        currentCategory = category;
        currentAuthor = '';
        loadShownQuotes();
        showQuoteSection();
        
        if (allQuotes.length > 0) {
            showQuoteFromCategory();
        } else {
            fetchAllQuotes();
        }
    }
}

// ============================================
// INITIALIZATION
// ============================================

console.log('‚ú® Quote Galaxy with Zen Backgrounds, Journeys, Story Cards & Authors initialized!');

loadTheme();

const detectedLang = detectLanguage();
languageSelect.value = detectedLang;
setLanguage(detectedLang);

detectDevice();

const cached = getCachedQuotes();
if (cached.length > 0) {
    allQuotes = cached;
    console.log('üì¶ Loaded', allQuotes.length, 'quotes from cache');
}

if (!localStorage.getItem('theme')) {
    const month = new Date().getMonth();
    let seasonalTheme = 'vscode-dark';
    
    if (month >= 2 && month <= 4) seasonalTheme = 'spring';
    else if (month >= 5 && month <= 7) seasonalTheme = 'summer';
    else if (month >= 8 && month <= 10) seasonalTheme = 'autumn';
    else seasonalTheme = 'winter';
    
    setTheme(seasonalTheme);
}

handleURLParams();


// ============================================
// ACCESSIBLE CONTRAST FOR SETTINGS BUTTONS
// ============================================
function getLuminance(hex) {
    const c = hex.replace('#', '');
    const r = parseInt(c.substring(0,2), 16) / 255;
    const g = parseInt(c.substring(2,4), 16) / 255;
    const b = parseInt(c.substring(4,6), 16) / 255;
    const a = [r, g, b].map(v => v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
    return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
}

function bestTextColor(bgHex) {
    try {
        const L = getLuminance(bgHex);
        return L > 0.5 ? '#111111' : '#ffffff';
    } catch (e) {
        return '#111111';
    }
}

function applySettingsContrast() {
    const panel = document.getElementById('settings');
    if (!panel) return;

    const bg = getComputedStyle(panel).backgroundColor; // rgb(r,g,b)
    const m = bg.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (!m) return;

    const hex = '#' + [m[1], m[2], m[3]].map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
    const color = bestTextColor(hex);

    panel.querySelectorAll('.theme-btn, .seasonal-btn').forEach(btn => {
        if (!btn.classList.contains('active')) {
            btn.style.color = color;
            btn.style.textShadow = 'none';
        }
    });

    panel.querySelectorAll('.theme-btn span, .seasonal-btn span').forEach(el => {
        el.style.color = color;
    });
}

// Hook into theme change
const __setTheme = setTheme;
setTheme = function(name) {
    __setTheme(name);
    setTimeout(applySettingsContrast, 50);
};

// Run on load
applySettingsContrast();
